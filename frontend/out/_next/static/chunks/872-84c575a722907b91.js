"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[872],{5872:(e,t,a)=>{a.d(t,{sd:()=>B});var s=a(4823),n=a(9545),l=a(8101);let r=(0,n.c)("ChartBar",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"M7 16h8",key:"srdodz"}],["path",{d:"M7 11h12",key:"127s9w"}],["path",{d:"M7 6h3",key:"w9rmul"}]]),i=(0,n.c)("CircleStop",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["rect",{x:"9",y:"9",width:"6",height:"6",rx:"1",key:"1ssd4o"}]]),o=(0,n.c)("Sparkles",[["path",{d:"M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z",key:"4pj2yx"}],["path",{d:"M20 3v4",key:"1olli1"}],["path",{d:"M22 5h-4",key:"1gvqau"}],["path",{d:"M4 17v2",key:"vumght"}],["path",{d:"M5 18H3",key:"zchphs"}]]),d=(0,n.c)("Table",[["path",{d:"M12 3v18",key:"108xh3"}],["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}]]),c=({type:e=null,message:t=null,svg:a=null,children:s=null,classNames:l})=>n.j.jsxs("div",{className:(0,n.t)("agent-loader",l),children:[a&&a,n.j.jsxs("div",{className:"w-full h-40 flex text-sm flex-col items-center justify-center dark:text-gray-300",children:[t,n.j.jsx(n.b,{classNames:"text-gray-400 dark:text-gray-500 mt-3 mx-0"})]}),"error"===e&&n.j.jsx("h2",{children:"ERROR"}),s&&n.j.jsx("div",{className:"searchState-child",children:s})]});function u({questions:e,handleSubmit:t,globalLoading:a}){let s=(0,l.useRef)(e);return e?n.j.jsx("div",{className:"p-6 bg-transparent",children:n.j.jsxs("div",{className:"mb-4 text-sm text-gray-500 dark:text-gray-400",onKeyDown:e=>{"Enter"===e.key&&t({clarification_questions:s.current},"clarify")},children:[e.length?e.map((e,t)=>n.j.jsx("div",{className:"w-full",children:n.j.jsxs("div",{children:[n.j.jsx("p",{className:"q-desc m-0 mb-2 text-primary-text dark:text-gray-200",children:e.question}),n.j.jsx("div",{className:"w-full mb-4 min-w-64",children:n.j.jsx(n.m,{onChange:e=>{s.current[t].response=e.target.value},defaultValue:e.response,placeholder:"Your response. Leave blank if the question above is not relevant",inputClassNames:"ring-0 bg-transparent rounded-none border-b border-dotted border-gray-300 dark:border-gray-600 focus:border-blue-500 focus:border-solid focus:ring-0 focus:border-b-primary-highlight shadow-none pl-0 w-full dark:text-gray-200"})})]})},e.question)):null,n.j.jsx("button",{className:"underline text-gray-400 dark:text-gray-500 text-sm mt-4 cursor-pointer hover:text-gray-600 dark:hover:text-gray-300",onClick:()=>t({clarification_questions:s.current},"clarify"),disabled:a,children:"Click here or press enter to submit"})]})}):n.j.jsx("div",{className:"agent-error",children:"Something went wrong, please retry or contact us if it fails again."})}let y={url:null,onMessage:()=>{},onOpen:()=>{},onClose:()=>{},onError:()=>{},onTimeout:()=>{},reconnectDelay:2e3,reconnectMaxAttempts:3,ping:!1,autoReconnect:!0,connectionTimeoutAfter:1e4,connectImmediately:!0};function m({dbName:e,analysisId:t,question:a,data_csv:r,apiEndpoint:i,sql:d,token:c}){let[u,m]=(0,l.useState)(""),[h,g]=(0,l.useState)(!1),f=(0,n.s)({protocol:"ws",path:"analyse_data_streaming",apiEndpoint:i});return(0,l.useEffect)(()=>{let s=(0,n.q)(t);if(s){m(s);return}let l=function(e){let t={...y,...e},{url:a,reconnectDelay:s,reconnectMaxAttempts:n,ping:l,autoReconnect:r,connectionTimeoutAfter:i}=t,o=null,d=!1,c=null,u=null,m=Date.now(),h=-1,g=0,f=!1,x=t.onMessage,p=t.onOpen,j=t.onClose,b=t.onError,v=t.onTimeout,w=crypto.randomUUID().slice(0,8),N=[];function A(...e){d&&(console.groupCollapsed(w+": "+(e.length&&e[0])),console.log(...e),console.groupEnd())}function C(){h++,q(),o&&o.close&&o.readyState!==WebSocket.CLOSED&&o.close(),o=new WebSocket(a),A("connecting"),c=setTimeout(()=>{A("connection timed out"),o.readyState===WebSocket.CONNECTING&&(o.close(),h<n?(h++,setTimeout(C,s)):v&&"function"==typeof v&&v())},i),o.onopen=function(e){A("reconnected to",a),h=0,q(),p&&"function"==typeof p&&p(e)},o.onerror=function(e){A("error",a,e),b&&"function"==typeof b&&b(e)},o.onmessage=function(e){x&&"function"==typeof x&&x(e)},N.forEach(e=>{if(e.disabled)return;let t=e.event,a=e.cb;e.disabled=!1,o.addEventListener(t,a)}),o.onclose=function(e){A("closed",e),j&&"function"==typeof j&&j(e),q(),e.wasClean||f||(r&&A(`reconnecting to ${a}, in ${s} ms`),u=setTimeout(()=>{if(r){if(h>=n){A("Maximum number of reconnect attempts reached. Stopping reconnecting.");return}A("reconnecting to",a),C()}},s))}}function I(e,t=!1){o&&o.readyState===WebSocket.OPEN&&(h>=1&&!t&&g%10==0&&(A("Connection was previously lost and there might be connectivity issues while running this. Consider refreshing the page for best performance."),g++),o.send(JSON.stringify(e)))}function q(){clearTimeout(c),clearTimeout(u)}return l&&window.requestAnimationFrame(function e(){Date.now()-m>5e3&&(m=Date.now(),I({ping:"ping"},!0)),window.requestAnimationFrame(e)}),t.connectImmediately&&C(),{send:I,destroy:function(){q(),A("Closing socket and destroying manager",o),f=!0,o&&o.close(),A("destroyed")},connect:C,addEventListener:function(e,t){d&&A("adding event listeners"),o&&(o.addEventListener(e,t),N.push({event:e,cb:t,disabled:!1}))},removeEventListener:function(e,t,a){A("removing event listeners"),o&&(o.removeEventListener(e,t),-1!==a&&(N[a].disabled=!0))},isConnected:function(){return o&&o.readyState===WebSocket.OPEN},setLogging:function(e=!1){d=e},getSocket:function(){return o},getEventListeners:function(){return N}}}({url:f,onMessage:e=>{g(!1);let a=e.data;"Defog data analysis has ended"===a?(l.destroy(),m(e=>((0,n.r)(t,e),e))):m(e=>e+a)},reconnectDelay:2e3,reconnectMaxAttempts:3,connectionTimeoutAfter:1e4,onTimeout:()=>{g(!1),m("Connection timeout with the websocket server. Please try again.")},onOpen:()=>{g(!0),m(""),l.send({question:a,data_csv:r,sql:d,db_name:e,token:c})},onError:e=>{console.error(e),g(!1),m("An error occurred while analyzing data. Please try again.")}});return()=>{l.destroy()}},[]),n.j.jsxs("div",{className:"relative h-full",children:[n.j.jsx("div",{className:"pb-3 mb-4 border-b border-gray-200 dark:border-gray-700",children:n.j.jsxs("h3",{className:"font-medium text-gray-900 text-md dark:text-gray-100",children:["Insights"," ",n.j.jsx(o,{className:"inline size-4 stroke-secondary-highlight-1"})]})}),n.j.jsx("div",{className:"space-y-4",children:h?n.j.jsxs("div",{className:"flex flex-col items-center justify-center p-8 h-[400px] rounded-lg bg-gray-50 dark:bg-gray-800/50",children:[n.j.jsx(n.b,{classNames:"mb-4"}),n.j.jsxs("div",{className:"flex flex-col items-center",children:[n.j.jsx("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Analyzing your data"}),n.j.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"This may take a few moments"})]})]}):u?n.j.jsx(s.h,{customErrorMessage:u,children:n.j.jsx("div",{className:`analysis-markdown max-w-full text-sm break-words
                [&>h1]:text-xl [&>h1]:font-semibold [&>h1]:mb-4 [&>h1]:text-gray-900 [&>h1]:dark:text-gray-100
                [&>h2]:text-lg [&>h2]:font-medium [&>h2]:mb-3 [&>h2]:text-gray-800 [&>h2]:dark:text-gray-200
                [&>p]:mb-4 [&>p]:text-gray-600 [&>p]:dark:text-gray-300 [&>p]:leading-relaxed [&>p]:whitespace-pre-wrap
                [&>ul]:mb-4 [&>ul]:list-disc [&>ul]:pl-5 [&>ul]:space-y-2 [&>ul]:text-gray-600 [&>ul]:dark:text-gray-300
                [&>ol]:mb-4 [&>ol]:list-decimal [&>ol]:pl-5 [&>ol]:space-y-2 [&>ol]:text-gray-600 [&>ol]:dark:text-gray-300
                [&>blockquote]:border-l-4 [&>blockquote]:border-gray-200 [&>blockquote]:dark:border-gray-700 
                [&>blockquote]:pl-4 [&>blockquote]:italic [&>blockquote]:my-4 [&>blockquote]:text-gray-600 [&>blockquote]:dark:text-gray-300`,dangerouslySetInnerHTML:{__html:(0,s.s)((0,s.m)(u))}})}):null})]})}let h=({isOpen:e,onClick:t})=>n.j.jsx("button",{onClick:t,className:`
      absolute -left-8 top-1/2 -translate-y-1/2
      h-36 w-8 flex items-center justify-center group
      bg-[#F9FAFB] dark:bg-gray-800 
      border border-gray-200 dark:border-gray-700
      hover:bg-gray-50 dark:hover:bg-gray-700
      transition-colors rounded-l
      ${e?"":"z-10"}
    `,title:`${e?"Collapse":"Expand"} analysis panel (${n.w.TOGGLE_ANALYSIS})`,children:n.j.jsxs("div",{className:"relative flex flex-col h-full",children:[n.j.jsx("div",{className:"flex items-center justify-center flex-1",children:n.j.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:n.j.jsx(o,{className:"w-4 h-4"})})}),n.j.jsx("div",{className:"absolute -translate-x-1/2 bottom-2 left-1/2",children:n.j.jsx(n.K,{shortcut:n.w.TOGGLE_ANALYSIS,className:"scale-75"})})]})});function g({dbName:e,analysis:t=null,analysisTreeManager:a=null}){var i,o;let{apiEndpoint:c,token:u}=(0,l.useContext)(s.Q),y=(0,l.useRef)(null),[g,f]=(0,l.useState)(null==(i=null==t?void 0:t.data)?void 0:i.sql),[x,p]=(0,l.useState)(!1),[j,b]=(0,l.useState)(!0),[v,w]=(0,l.useState)(!1),N=(0,l.useContext)(n.a),A=t.analysis_id,C=null==(o=null==t?void 0:t.data)?void 0:o.parsedOutput;async function I(){if(x)return;let e="";try{let t=null==C?void 0:C.data;if(!t)return;let{columns:a,data:s}=t,n=a.filter(e=>"index"!==e.title);e=n.map(e=>e.title).join(",")+`
`;for(let t=0;t<s.length;t++){let a=s[t];for(let t=0;t<n.length;t++)e+=a[n[t].title],t<n.length-1&&(e+=",");e+=`
`}let l=new Blob([e],{type:"text/csv"}),r=URL.createObjectURL(l),i=document.createElement("a");i.href=r,i.download=`${A}-${new Date().toISOString().split(".")[0]}.csv`,i.click(),URL.revokeObjectURL(r),i.remove(),N.success("CSV saved.")}catch(e){console.error(e),N.error("Error saving CSV.")}finally{p(!1)}}let q=(0,l.useSyncExternalStore)(e=>a.subscribeToActiveTabChanges(t.analysis_id,e),()=>a.getActiveTab(t.analysis_id)),[S,E]=(0,l.useState)([]),_=(0,l.useMemo)(()=>{var a,s;return(null==C?void 0:C.csvString)&&n.j.jsx(m,{analysisId:t.analysis_id,dbName:e,question:null==(a=null==t?void 0:t.data)?void 0:a.initial_question,data_csv:null==C?void 0:C.csvString,sql:null==(s=null==t?void 0:t.data)?void 0:s.sql,apiEndpoint:c,token:u})},[t,e,c]),T=(0,l.useMemo)(()=>{var e;return C&&n.j.jsx(s.i,{stepData:C,initialQuestion:null==(e=null==t?void 0:t.data)?void 0:e.initial_question,initialOptionsExpanded:v})},[t,v]),R=e=>n.j.jsxs("div",{className:"flex",children:[n.j.jsx("div",{className:`
          transition-all duration-200 pr-6
          ${j?"w-[70%]":"w-[95%]"}
        `,children:e}),n.j.jsxs("div",{className:`
          relative
          transition-all duration-200 
          border-l border-gray-200 dark:border-gray-700
          ${j?"w-[30%]":"lg:w-[5%] w-0"}
        `,children:[n.j.jsxs("div",{className:"flex items-start",children:[n.j.jsx(h,{isOpen:j,onClick:()=>b(!j)}),n.j.jsxs("div",{className:"relative ml-2",onClick:()=>!j&&b(!0),children:[!j&&n.j.jsx("div",{className:"absolute inset-0 cursor-pointer",title:"Expand analysis panel"}),j&&n.j.jsx("div",{className:"relative w-[100%] max-h-[600px] overflow-y-auto",children:_})]})]}),n.j.jsx("div",{className:`
            absolute inset-y-0 right-0 w-24
            transition-opacity duration-200
            ${j?"opacity-0 pointer-events-none":"opacity-100"}
            bg-gradient-to-r from-transparent 
            via-white/50 to-white
            dark:via-gray-800/50 dark:to-gray-800
          `})]})]});return(0,l.useEffect)(()=>{let e=[],t=null==C?void 0:C.data;if(t){let a=(0,n.v)(t.data,t.columns);e.push({component:R(n.j.jsx(n.f,{rootClassNames:"lg:pl-0",rows:a,columns:t.columns.filter(e=>"index"!==e.title).map(e=>(e.render=e=>n.j.jsx("div",{children:e}),e)),pagination:{defaultPageSize:10,showSizeChanger:!0}})),key:"table",tabLabel:"Table",icon:n.j.jsx(d,{className:"w-4 h-4 mb-0.5 mr-1 inline"})}),null!=C&&C.data&&e.push({component:R(n.j.jsx(s.h,{children:T})),key:"chart",tabLabel:"Chart",icon:n.j.jsx(r,{className:"w-4 h-4 mb-0.5 mr-1 inline"})})}E(e)},[t,g,j]),(0,l.useEffect)(()=>{let e=e=>{document.activeElement!==document.body||e.metaKey||e.ctrlKey||e.altKey||e.shiftKey||((0,n.y)(e.key,n.w.TOGGLE_ANALYSIS)&&(b(e=>!e),e.preventDefault()),(0,n.y)(e.key,n.w.TOGGLE_CHART_OPTIONS)&&"chart"===q&&(w(e=>!e),e.preventDefault()),(0,n.y)(e.key,n.w.VIEW_TABLE)&&(null==a||a.setActiveTab(A,"table"),e.preventDefault()),(0,n.y)(e.key,n.w.VIEW_CHART)&&(null==a||a.setActiveTab(A,"chart"),e.preventDefault()))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[q,A,a]),n.j.jsx("div",{className:"table-chart-ctr",ref:y,children:n.j.jsxs("div",{className:"flex flex-col w-full",children:[n.j.jsx("div",{className:"border-b border-gray-200",children:n.j.jsxs("div",{className:"flex items-center justify-between",children:[n.j.jsx("nav",{className:"flex space-x-4","aria-label":"Tabs",children:S.map(e=>n.j.jsxs("button",{onClick:()=>a.setActiveTab(A,e.key),className:`
                    px-3 py-2 text-sm font-medium rounded-t-lg flex items-center gap-2
                    ${q===e.key?"border-b-2 border-blue-500 text-blue-600":"text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300"}
                  `,children:[n.j.jsxs("span",{className:"flex items-center",children:[e.icon,e.tabLabel]}),"table"===e.key&&n.j.jsx(n.K,{shortcut:n.w.VIEW_TABLE,className:"opacity-50 px-1 py-0.5"}),"chart"===e.key&&n.j.jsx(n.K,{shortcut:n.w.VIEW_CHART,className:"opacity-50 px-1 py-0.5"})]},e.key))}),n.j.jsxs(n.B,{onClick:async()=>{await I()},disabled:x,variant:"secondary",className:`flex mb-2 items-center px-2.5 py-1.5 hover:text-white text-white rounded-md border border-blue-200/50 
                bg-blue-500 hover:bg-blue-600/95 dark:bg-blue-900/20 dark:hover:bg-blue-800/30 
                shadow-sm  transition-all duration-200 
                dark:border-blue-700/50 dark:hover:border-blue-600/50
                hover:shadow-md hover:-translate-y-0.5
                group`,children:[n.j.jsx(n.x,{size:16,className:"mr-1"}),n.j.jsx("span",{children:"Download CSV"})]})]})}),n.j.jsx("div",{className:"relative mt-4",children:S.map(e=>n.j.jsx("div",{className:e.key===q?"z-2":"absolute overflow-hidden top-[-100%] z-[-1] pointer-events-none *:pointer-events-none opacity-0",children:e.component},e.key))})]})})}function f({error_message:e=null}){return n.j.jsxs("div",{className:"p-4 mb-4 border rounded-lg bg-rose-50 dark:bg-rose-900/20 border-rose-200 dark:border-rose-800",children:[n.j.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[n.j.jsx(n.C,{className:"w-4 h-4 text-rose-500 dark:text-rose-400"}),n.j.jsx("span",{className:"font-semibold text-rose-700 dark:text-rose-300",children:"An error occurred"})]}),n.j.jsx("div",{className:"pl-6 text-rose-600 dark:text-rose-400",children:e||"Something went wrong"})]})}function x({initialInputs:e,handleEdit:t}){let[a,r]=(0,l.useState)(e);function i(e,s){let n={...a};n[e]=s,r(n),t&&t(e,s)}return n.j.jsxs("div",{className:"text-sm text-gray-700 tool-input-list dark:text-gray-300",children:[a.question&&n.j.jsxs("div",{className:"mb-6",children:[n.j.jsxs("div",{className:"flex flex-row flex-wrap items-center gap-3 font-mono text-xs",children:[n.j.jsx("span",{className:"p-1 mr-2 text-gray-400 bg-gray-200 rounded-lg dark:bg-gray-700 dark:text-gray-400",children:"String"}),n.j.jsx("span",{className:"font-bold",children:"question"})]}),n.j.jsx("div",{className:"mt-2",children:n.j.jsx(n.T,{rootClassNames:"w-full",textAreaClassNames:"resize-none overflow-auto text-sm",value:a.question,defaultRows:1,onChange:e=>{i("question",e.target.value)}})})]}),a.hard_filters&&n.j.jsxs("div",{className:"space-y-4",children:[n.j.jsxs("div",{className:"flex flex-row flex-wrap items-center gap-3 font-mono text-xs",children:[n.j.jsx("span",{className:"p-1 mr-2 text-gray-400 bg-gray-200 rounded-lg dark:bg-gray-700 dark:text-gray-400",children:"List"}),n.j.jsx("span",{className:"font-bold",children:"hard_filters"})]}),n.j.jsxs("div",{className:"pb-4 space-y-2",children:[a.hard_filters.map((e,t)=>n.j.jsxs("div",{className:"flex items-center gap-2 group",children:[n.j.jsx(n.m,{rootClassNames:"flex-1",value:e,placeholder:"Filter condition",onChange:e=>{let s=[...a.hard_filters];s[t]=e.target.value,i("hard_filters",s)}}),n.j.jsxs("button",{className:"p-1.5 text-gray-400  group-hover:text-red-500 transition-opacity",onClick:()=>{i("hard_filters",a.hard_filters.filter((e,a)=>a!==t))},children:[n.j.jsx("span",{className:"sr-only",children:"Remove filter"}),n.j.jsx(s.J,{size:16})]})]},t)),n.j.jsxs("button",{onClick:()=>i("hard_filters",[...a.hard_filters||[],""]),className:"flex mt-4 items-center gap-1.5 text-xs font-medium text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 transition-colors",children:[n.j.jsx(s.K,{size:14}),n.j.jsx("span",{children:"Add Filter"})]})]})]})]})}let p=({dbName:e,question:t,sql:a})=>{let[r,i]=(0,l.useState)(!1),[o,d]=(0,l.useState)(!1),[c,u]=(0,l.useState)(`






`),{apiEndpoint:y,token:m}=(0,l.useContext)(s.Q),h=(0,l.useContext)(n.a),g=(0,l.useCallback)(e=>{u(e)},[]),f=async()=>{d(!0),!0===(await (await fetch(y+"/integration/update_golden_queries",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:m,db_name:e,golden_queries:[{question:t,sql:c}]})})).json()).success?h.success("Feedback submitted successfully"):h.error("Failed to submit feedback"),d(!1),i(!1)};return n.j.jsxs("div",{className:"h-10 mt-2",children:[n.j.jsx("div",{className:"flex items-left h-10 gap-1",children:n.j.jsx("div",{className:"flex items-center justify-center w-40 h-10 rounded-full cursor-pointer",onClick:()=>{i(!0)},children:n.j.jsx("span",{className:"text-xs",children:"Bad result? Teach model to do better."})})}),n.j.jsx(n.l,{title:"Align the model by providing feedback",open:r,footer:null,onCancel:()=>i(!1),contentClassNames:"overflow-auto",children:n.j.jsxs("div",{className:"mt-4 dark:text-gray-200",children:[n.j.jsxs("p",{className:"mb-2",children:["Please provide the correct SQL query for answering this question. The question was:"," ",n.j.jsx("span",{className:"font-mono dark:text-blue-300 text-blue-500",children:t}),n.j.jsx("br",{})]}),n.j.jsx("p",{className:"mb-2",children:"The query originally generated by Defog was:"}),n.j.jsx(s.R,{theme:"dark",extensions:[(0,s.L)(),s.M.lineWrapping],value:a,basicSetup:{lineNumbers:!1},editable:!1,minHeight:"200px",className:"dark:bg-gray-800 rounded-md"}),n.j.jsx("p",{className:"mb-2",children:"Please enter the correct SQL query below:"}),n.j.jsx(s.R,{theme:"dark",extensions:[(0,s.L)(),s.M.lineWrapping],value:c,onChange:g,basicSetup:{lineNumbers:!1},editable:!0,minHeight:"200px",className:"dark:bg-gray-800 rounded-md"}),n.j.jsx("button",{className:"bg-blue-500 hover:bg-blue-700 text-white dark:bg-blue-600 dark:hover:bg-blue-800 font-bold py-2 px-4 rounded text-xs",onClick:f,children:"Submit SQL"})]})})]})},j=({dbName:e,question:t,submitFollowOn:a=e=>{}})=>{let[r,i]=(0,l.useState)([]),{apiEndpoint:o,token:d}=(0,l.useContext)(s.Q);async function c(){try{let a=(0,n.s)({protocol:"http",path:"query-data/generate_follow_on_questions",apiEndpoint:o}),s=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_question:t,db_name:e,token:d})});if(s.ok){let e=await s.json();i(e.follow_on_questions||[])}else throw Error("Error generating follow on questions")}catch(e){console.error(e)}}return(0,l.useEffect)(()=>{c()},[]),n.j.jsx("div",{className:"p-4",children:n.j.jsx("div",{className:"max-w-[900px] w-full m-auto flex flex-row gap-4 justify-center",children:r&&r.length?r.map((e,t)=>n.j.jsx("button",{"data-testid":"follow-on-question",className:"p-2 m-1 text-sm text-gray-700 bg-white border border-gray-200 rounded-md shadow-sm cursor-pointer grow basis-1 dark:border-gray-600 dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 dark:text-gray-200",onClick:()=>{a(e)},children:e},t)):null})})};function b({dbName:e,analysis:t,analysisBusy:a=!1,handleReRun:r=e=>{},submitFollowOn:i=e=>{},analysisTreeManager:o=null}){var d,u,y,m,h,b,v;let{hideSqlTab:w}=(0,l.useContext)(s.Q),N=null==t?void 0:t.data;null==t||t.analysis_id;let A=(0,l.useRef)({question:(null==(u=null==(d=null==t?void 0:t.data)?void 0:d.inputs)?void 0:u.question)||"",sql:(null==(y=null==t?void 0:t.data)?void 0:y.sql)||"",hard_filters:(null==(h=null==(m=null==t?void 0:t.data)?void 0:m.inputs)?void 0:h.hard_filters)||[]}),C=(0,l.useCallback)((e,t)=>{e&&(A.current[e]=t)},[N]),I=(0,l.useMemo)(()=>{var l,d,c;return[{name:"SQL/Code",content:n.j.jsxs(s.h,{maybeOldAnalysis:!0,children:[(null==N?void 0:N.error)&&n.j.jsx(f,{error_message:null==N?void 0:N.error}),n.j.jsx("div",{className:"flex ",children:n.j.jsx("div",{className:"w-full",children:n.j.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:[n.j.jsx("div",{className:"space-y-6",children:n.j.jsxs("div",{className:"space-y-2",children:[n.j.jsx("h3",{className:"text-xs font-medium text-gray-400 uppercase",children:"Inputs"}),n.j.jsx("div",{className:"p-4 rounded-lg bg-gray-50 dark:bg-gray-800",children:n.j.jsx(x,{initialInputs:null==N?void 0:N.inputs,handleEdit:C})})]})}),n.j.jsxs("div",{className:"space-y-6",children:[n.j.jsxs("div",{className:"space-y-2",children:[n.j.jsx("h3",{className:"text-xs font-medium text-gray-400 uppercase",children:"Generated SQL"}),n.j.jsx("div",{className:"rounded-lg ",children:n.j.jsx(s.C,{className:"tool-code-ctr",code:(null==N?void 0:N.sql)||"",language:"sql",editable:!0,handleEdit:C,updateProp:"sql"})})]}),(null==N?void 0:N.instructions_used)&&n.j.jsxs("div",{className:"space-y-2",children:[n.j.jsx("h3",{className:"text-xs font-medium text-gray-400 uppercase",children:"Instructions used for this query"}),n.j.jsx("div",{className:"p-4 rounded-lg bg-gray-50 dark:bg-gray-800",children:n.j.jsx("p",{className:"text-sm leading-relaxed text-gray-600 dark:text-gray-300 whitespace-break-spaces",children:N.instructions_used})})]}),n.j.jsxs("div",{className:"flex justify-between mt-auto",children:[n.j.jsx(p,{dbName:e,question:null==(l=null==N?void 0:N.inputs)?void 0:l.question,sql:null==N?void 0:N.sql}),n.j.jsx("div",{className:"flex justify-end ",children:n.j.jsx(n.B,{disabled:a,className:"h-10 px-4 py-2 font-mono text-white bg-gray-600 border border-gray-200 hover:bg-blue-500 hover:text-white active:hover:text-white hover:border-transparent",onClick:()=>r(A.current),children:"Re run"})})]})]})]})})})]})},{name:"Analysis",content:n.j.jsxs("div",{children:[n.j.jsx(g,{dbName:e,analysis:t,analysisTreeManager:o}),(null==N?void 0:N.sql)&&n.j.jsx(p,{dbName:e,question:null==(d=null==N?void 0:N.inputs)?void 0:d.question,sql:null==N?void 0:N.sql}),n.j.jsx(j,{dbName:e,question:null==(c=null==N?void 0:N.inputs)?void 0:c.question,submitFollowOn:i})]},crypto.randomUUID())}]},[N,a]);return null!=N&&N.parsedOutput?n.j.jsxs("div",{className:"w-full h-full tool-results-ctr",children:[a&&n.j.jsxs("div",{className:"absolute top-0 left-0 z-20 flex flex-col items-center justify-center w-full h-full bg-white dark:bg-gray-900 bg-opacity-90 dark:bg-opacity-90 text-md dark:text-gray-300",children:[n.j.jsxs("span",{className:"my-1",children:[n.j.jsx(n.b,{}),"Running"]}),n.j.jsx(n.z,{classNames:"text-gray-500 dark:text-gray-400 w-5 h-5"})]}),a?n.j.jsx("div",{className:"tool-run-loading",children:n.j.jsx(c,{message:"Running analysis..."})}):n.j.jsx(n.j.Fragment,{children:w?n.j.jsx("div",{children:null==(v=null==(b=I.filter(e=>"Analysis"===e.name))?void 0:b[0])?void 0:v.content}):n.j.jsx(n.e,{disableSingleSelect:!0,defaultSelected:"Analysis",tabs:I})})]}):n.j.jsx(n.j.Fragment,{})}let v=({analysisId:e,rootAnalysisId:t,dbName:a,isTemp:r=!1,metadata:o=null,sqlOnly:d=!1,rootClassNames:y="",createAnalysisRequestBody:m={},initiateAutoSubmit:h=!1,hasExternalSearchBar:g=!1,searchBarPlaceholder:f=null,extraTools:x=[],plannerQuestionSuffix:p=null,previousContextCreator:j=()=>[],setGlobalLoading:v=(...e)=>{},onManagerCreated:w=(...e)=>{},onManagerDestroyed:N=(...e)=>{},disabled:A=!1,initialConfig:C={analysisManager:null,analysisTreeManager:null},submitFollowOn:I=(...e)=>{},onHeightChange:q=(...e)=>{}})=>{var S,E,_,T,R,O,M,D,L;let{apiEndpoint:B,token:P,updateConfig:F,analysisDataCache:z}=(0,l.useContext)(s.Q),Q=(0,l.useRef)(null),U=(0,l.useRef)(null),$=(0,l.useRef)(null);(0,l.useEffect)(()=>{var e;if(!U.current||!q)return;null==(e=$.current)||e.disconnect();let t=new ResizeObserver(e=>{e.forEach(e=>{q(e.contentRect.height)})});return t.observe(U.current),$.current=t,()=>{var e;null==(e=$.current)||e.disconnect(),$.current=null}},[q]);let G=(0,l.useContext)(n.a),W=(0,l.useMemo)(()=>C.analysisManager||function({analysisId:e,rootAnalysisId:t,apiEndpoint:a,token:l,dbName:r,metadata:i,isTemp:o,sqlOnly:d=!1,extraTools:c=[],plannerQuestionSuffix:u="",previousContextCreator:y=()=>[],onNewData:m=(...e)=>{},onManagerDestroyed:h=(...e)=>{},onAbortError:g=(...e)=>{},createAnalysisRequestBody:f={}}){let x=null,p=!1,j=[],b=!1,v=!1,w=!1,N=[],A=(0,n.s)({protocol:"http",path:"query-data/clarify",apiEndpoint:a}),C=(0,n.s)({protocol:"http",path:"query-data/generate_analysis",apiEndpoint:a}),I=(0,n.s)({protocol:"http",path:"query-data/rerun",apiEndpoint:a});function q(e){var t;e&&(null!=(t=null==e?void 0:e.data)&&t.output&&(e.data.parsedOutput=function(e){let t={};return t.csvString=e,t.data=(0,n.p)(e),t.chartManager=(0,s.I)({data:t.data.data,availableColumns:t.data.columns}),t}(e.data.output)),x=e,j.forEach(e=>e()))}function S(e){w=e,N.forEach(e=>e(w))}async function E(a,s={}){try{var n;if(b)throw Error("Analysis Manager already destroyed.");S(!0);let i=null!=(n=null==x?void 0:x.data)&&n.clarification_questions?"generate_analysis":"clarify",m;"clarify"===i?m=A:"generate_analysis"===i&&(m=C);let h={...s,request_type:i,analysis_id:e,user_question:a,sql_only:d,token:l,temp:o,db_name:r,db_creds:null,previous_context:y(),root_analysis_id:t,extra_tools:c,planner_question_suffix:u};if(console.groupCollapsed("Analysis Manager submitting"),console.log("Request body",h),!m)throw Error("Endpoint not found");let g=await fetch(m,{method:"POST",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(6e4),body:JSON.stringify(h)});if(!g.ok)throw Error("Failed to submit.");let f=await g.json();console.log(f),console.groupEnd(),q(f)}catch(e){console.log(e),g(e)}finally{S(!1)}}async function _(t){if(!t)throw Error("No inputs provided");try{S(!0);let a=await fetch(I,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:l,db_name:r,analysis_id:e,edited_inputs:t})});if(!a.ok)throw Error("Could not rerun step");let s=await a.json();q(s)}catch(e){throw Error(e instanceof Error?e.message:"Unknown error")}finally{S(!1)}}return{init:async function({question:t,existingData:s=null}){v=!0;let i=null,o=!1;if(s)i=s,o=!1;else{let t=await (0,n.n)(e,l,a);t?i=t:(i=await (0,n.o)(l,r,a,e,f),o=!0),p=o}q(i)},get wasNewAnalysisCreated(){return p},set wasNewAnalysisCreated(k){p=k},get didInit(){return v},get analysis(){return x},getAnalysis:function(){return x||null},subscribeToDataChanges:function(e){return j=[...j,e],function(){j=j.filter(t=>t!==e)}},getAnalysisBusy:function(){return w},subscribeToAnalysisBusyChanges:function(e){return N=[...N,e],function(){N=N.filter(t=>t!==e)}},setAnalysisBusy:S,submit:E,reRun:_,destroy:function(){b&&console.warn("Already destroyed"),console.groupCollapsed("Destroying. Open for trace"),console.log("Destroying"),console.trace(),console.groupEnd(),b=!0,h()},setOnNewDataCallback:function(e){}}}({analysisId:e,rootAnalysisId:t,apiEndpoint:B,token:P,dbName:a,metadata:o,isTemp:r,sqlOnly:d,extraTools:x,plannerQuestionSuffix:p,previousContextCreator:j,onAbortError:e=>{G.error(e),v(!1)},onManagerDestroyed:()=>N(e,U.current),createAnalysisRequestBody:m}),[e,G]),V=(0,l.useSyncExternalStore)(W.subscribeToAnalysisBusyChanges,W.getAnalysisBusy),H=(0,l.useSyncExternalStore)(W.subscribeToDataChanges,W.getAnalysis);(0,l.useEffect)(()=>{var t,a,s,n,l,r,i,o;h&&null!=(t=null==H?void 0:H.data)&&t.initial_question&&!(null!=(a=null==H?void 0:H.data)&&a.clarification_questions)&&K(null==(s=null==H?void 0:H.data)?void 0:s.initial_question,{},null),null==(n=null==H?void 0:H.data)||!n.clarification_questions||(null==(l=null==H?void 0:H.data)?void 0:l.clarification_questions.length)!==0||null!=(r=null==H?void 0:H.data)&&r.parsedOutput||null!=(i=null==H?void 0:H.data)&&i.error||K(null==(o=null==H?void 0:H.data)?void 0:o.initial_question,{clarification_questions:[]}),F({analysisDataCache:{...z,[e]:H}}),v(!1)},[H]),(0,l.useEffect)(()=>{W.didInit||t();async function t(){var t;try{await W.init({question:null==(t=null==m?void 0:m.initialisation_details)?void 0:t.user_question,existingData:(null==z?void 0:z[e])||null}),W.wasNewAnalysisCreated&&F({analysisDataCache:{...z,[e]:H}})}catch(e){G.error(e.message),console.log(e.stack),W.destroy()}}},[]),(0,l.useEffect)(()=>{W&&w(W,e,U.current)},[W]);let K=(0,l.useCallback)((e,t={},a=null)=>{try{if(!e)throw Error("Query is empty");v(!0),W.submit(e,{...t})}catch(e){G.error(e),console.log(e.stack),v(!1),null===a&&g&&W.destroy()}},[W,v,G,d,g]),J=n.j.jsx(n.j.Fragment,{children:n.j.jsxs("div",{className:"flex flex-row flex-wrap items-center gap-4 p-6 transition-all duration-200 lg:items-start",children:[n.j.jsx("h1",{className:"font-bold text-xl text-gray-700 dark:text-gray-200 basis-0 grow min-w-[50%]",children:(0,n.A)((null==H?void 0:H.user_question)||m.user_question||"")}),!V&&H&&H&&(null!=(S=null==H?void 0:H.data)&&S.clarification_questions||!g)?null:n.j.jsx("div",{className:"cursor-pointer basis-0 text-nowrap whitespace-nowrap group",onClick:()=>{console.log("clicked"),v(!1),W.destroy()},children:n.j.jsx(i,{className:"w-6 h-6 text-rose-300 group-hover:text-rose-500 dark:text-rose-400 dark:group-hover:text-rose-600"})})]})});return n.j.jsx(s.h,{children:n.j.jsx("div",{ref:U,id:e,className:(0,n.t)("analysis-agent-container h-max min-h-20 relative grow outline-none focus:outline-none rounded-3xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 overflow-hidden",Q?"bg-gray-50 dark:bg-gray-900":"max-w-full",y),children:V?n.j.jsxs("div",{className:"flex flex-col w-full h-full bg-gray-50 dark:bg-gray-900 rounded-3xl max-h-96 border dark:border-gray-200",children:[J,n.j.jsx(c,{message:null!=(E=null==H?void 0:H.data)&&E.clarification_questions?"Fetching data...":"Thinking about whether I need to clarify the question...",classNames:"m-0 h-40 bg-transparent"})]}):n.j.jsxs(n.j.Fragment,{children:[g||null!=(_=null==H?void 0:H.data)&&_.clarification_questions?n.j.jsx(n.j.Fragment,{}):n.j.jsx("div",{className:"relative w-10/12 mx-auto top-6",children:n.j.jsx(n.m,{ref:Q,onPressEnter:e=>{K(e.target.value),e.target.value=""},placeholder:f||"Ask a question",disabled:A||V,inputClassNames:"w-full mx-auto shadow-custom hover:border-blue-500 focus:border-blue-500"})}),null!=(T=null==H?void 0:H.data)&&T.clarification_questions&&!(null!=(R=null==H?void 0:H.data)&&R.output)?n.j.jsxs("div",{className:"w-full transition-all bg-gray-50 dark:bg-gray-900 rounded-3xl",children:[J,n.j.jsx(u,{questions:(null==(O=null==H?void 0:H.data)?void 0:O.clarification_questions)||[],handleSubmit:(e,t)=>{K(null==H?void 0:H.user_question,e,t)},globalLoading:V})]}):n.j.jsx(n.j.Fragment,{}),(null==(M=null==H?void 0:H.data)?void 0:M.output)&&(null==(D=null==H?void 0:H.data)?void 0:D.parsedOutput)&&n.j.jsx("div",{className:"flex flex-col-reverse w-full h-full analysis-content lg:flex-row",children:n.j.jsxs("div",{className:"relative flex flex-col min-w-0 analysis-results grow dark:border-gray-600",children:[J,n.j.jsx(s.h,{children:(null==(L=null==H?void 0:H.data)?void 0:L.parsedOutput)&&n.j.jsx(b,{dbName:a,analysis:H,analysisBusy:V,handleReRun:async e=>{console.log(e);try{await W.reRun(e)}catch(e){console.log(e),G.error(e.message)}},analysisTreeManager:null==C?void 0:C.analysisTreeManager,submitFollowOn:e=>{console.log("clicked follow on",e),I(e)}})})]})})]})})})};function w({analysis:e=null,activeAnalysisId:t=null,extraClasses:a="",isDummy:l=!1,onClick:r=(...e)=>{}}){let i=e&&t===e.analysisId;return n.j.jsx("div",{className:(0,n.t)("flex flex-row items-center dark:text-gray-300",l?"dummy-analysis bg-gray-100 dark:bg-gray-800 text-gray-900 hover:text-blue-600 m-0":e&&e.analysisId&&"border-b border-gray-100 dark:border-gray-800",a),children:n.j.jsxs("div",{className:"grow",children:[n.j.jsx("div",{className:(0,n.t)("title hover:cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 history-item p-2 text-sm",i?"font-medium bg-gray-100 dark:bg-gray-800 border-l-2 border-l-blue-500":""),onClick:()=>{r(e)},children:l?n.j.jsxs("div",{className:"flex flex-row items-center gap-2",children:[n.j.jsx(s.S,{})," ",n.j.jsx("span",{children:"New"})]}):(0,n.A)(null==e?void 0:e.user_question)}),!l&&e&&e.children&&e.children.length>0&&n.j.jsx("div",{className:"ml-1",children:e.children.map(e=>n.j.jsx(w,{analysis:e,activeAnalysisId:t,isDummy:l,extraClasses:"ml-2",onClick:r},e.analysisId))})]})})}let N=(e,t,a="smooth")=>{var s,n;null!=(n=null==(s=t.current)?void 0:s[e])&&n.ctr&&t.current[e].ctr.scrollIntoView({behavior:a,block:"start"})},A=(e,t)=>(0,l.useMemo)(()=>{try{let a=Object.keys(e).sort((t,a)=>{var s,n;return((null==(s=null==e?void 0:e[a])?void 0:s.timestamp)||0)-((null==(n=null==e?void 0:e[t])?void 0:n.timestamp)||0)}),s={Today:[],Yesterday:[],"Past week":[],"Past month":[],Earlier:[]},n=new Date,l=new Date(n);l.setDate(l.getDate()-1);let r=new Date(n);r.setDate(r.getDate()-7);let i=new Date(n);return i.setMonth(i.getMonth()-1),a.forEach(e=>{let a=t[e].root.timestamp,o=new Date(a);o.toDateString()===n.toDateString()?s.Today.push(e):o.toDateString()===l.toDateString()?s.Yesterday.push(e):o>=r?s["Past week"].push(e):o>=i?s["Past month"].push(e):s.Earlier.push(e)}),Object.keys(s).forEach(e=>{s[e].sort((e,a)=>{var s,n,l,r;return((null==(n=null==(s=null==t?void 0:t[a])?void 0:s.root)?void 0:n.timestamp)||0)-((null==(r=null==(l=null==t?void 0:t[e])?void 0:l.root)?void 0:r.timestamp)||0)})}),s}catch{return console.warn("Error in sorting keys. Returning as is."),{Earlier:Object.keys(e)}}},[e,t]),C=async(e,t,a,s,n,l,r,i,o,d)=>{let c="analysis-"+crypto.randomUUID(),{newAnalysis:u}=await e.submit({question:t,analysisId:c,rootAnalysisId:a?c:s,dbName:n,isRoot:a,directParentId:l,sqlOnly:i||r,isTemp:o,activeTab:d});return s||e.setActiveRootAnalysisId(u.analysisId),e.setActiveAnalysisId(u.analysisId),e.setActiveRootAnalysisId(u.rootAnalysisId),c},I=(e,t,a,s,r,i,o,d,c,u,y,m)=>(0,l.useCallback)(async(l,h=null,g=!1,f=null)=>{try{if(m(!0),!e)throw Error("Analysis tree manager not found");let u=e.getAll(),x="analysis",p="table";if(Object.keys(u).length>0){let e=await (0,n.H)(i,t,o,l);x=e.question_type,p=e.default_open_tab}if("edit-chart"===x){h?await q(u,l,c,d,e,i):await C(e,l,g,h,t,f,s,a,r,"chart");return}let j=await C(e,l,g,h,t,f,s,a,r,p);(0,n.J)(()=>{N(j,y)})}catch(e){d.error("Failed to create analysis"),console.error(e)}finally{u.current&&(u.current.value=""),m(!1)}},[e,a,s,r,t,y]),q=async(e,t,a,s,l,r)=>{var i,o,d,c;let u=(0,n.E)(Object.keys(e)),y=e[u.id],m=null==(d=null==(o=null==(i=null==y?void 0:y.analysisManager)?void 0:i.getAnalysis())?void 0:o.data)?void 0:d.parsedOutput;if(!m){s.error("No visible analysis found to edit chart");return}if(!(null!=(c=null==m?void 0:m.chartManager)&&c.config)){s.error("No chart found in the visible analysis");return}try{await m.chartManager.editChart(r,t,a,{onError:e=>{s.error(e.message),console.error(e)}}),l.setActiveTab(u.id,"chart")}catch(e){s.error(e.message),console.error(e)}},S=(e,t)=>{(0,l.useEffect)(()=>{Object.values(e).forEach(e=>{t.current[e.analysisId]={id:e.analysisId,ctr:document.getElementById(e.analysisId),analysisManager:e.analysisManager}})},[e])},E=(e,t,a,s,n)=>{(0,l.useEffect)(()=>{s.current&&(clearTimeout(s.current),s.current=null,n.current=!1),n.current=!0,s.current=setTimeout(()=>{e&&t&&a.current[e]&&N(e,a),n.current=!1},500)},[])},_=({dbName:e,activeRootAnalysisId:t,nestedTree:a,metadata:s,analysisDomRefs:l,analysisTreeManager:r,autoScroll:i,setLoading:o,submitFollowOn:d})=>{if(!t||!a[t])return null;let c=r.getActiveAnalysisId(),u=e=>(0,n.t)("w-full mb-4 [&_.analysis-content]:min-h-96 shadow-md transition-opacity duration-200",`analysis-${e}`,e===c?"ring-2 ring-blue-500 dark:ring-blue-400 bg-white dark:bg-gray-800 z-2 relative":"opacity-50 hover:opacity-75 bg-gray-50/80 dark:bg-gray-900/80 relative -z-0");return n.j.jsxs(n.j.Fragment,{children:[n.j.jsx(v,{dbName:e,setGlobalLoading:o,metadata:s,rootClassNames:u(t),analysisId:t,rootAnalysisId:t,createAnalysisRequestBody:a[t].createAnalysisRequestBody,initiateAutoSubmit:!0,hasExternalSearchBar:!0,sqlOnly:a[t].sqlOnly,isTemp:a[t].isTemp,previousContextCreator:()=>[],onManagerCreated:(e,s,n)=>{l.current[s]={ctr:n,analysisManager:e,id:s},r.updateAnalysis({analysisId:t,isRoot:a[t].isRoot,updateObj:{analysisManager:e}})},onManagerDestroyed:e=>{r.removeAnalysis({analysisId:t,isRoot:a[t].isRoot,rootAnalysisId:t}),r.setActiveAnalysisId(null),t===e&&r.setActiveRootAnalysisId(null),o(!1)},initialConfig:{analysisTreeManager:r},submitFollowOn:d},t),a[t].flatOrderedChildren.map(a=>n.j.jsx(v,{dbName:e,metadata:s,rootClassNames:u(a.analysisId),analysisId:a.analysisId,rootAnalysisId:a.rootAnalysisId,createAnalysisRequestBody:a.createAnalysisRequestBody,setGlobalLoading:o,initiateAutoSubmit:!0,hasExternalSearchBar:!0,sqlOnly:a.sqlOnly,isTemp:a.isTemp,previousContextCreator:()=>a.allParents.reverse().map(e=>{var t,a,s,n;let l=null==(t=null==e?void 0:e.analysisManager)?void 0:t.analysis;return l&&null!=l&&l.data?{question:null==(s=null==(a=null==l?void 0:l.data)?void 0:a.inputs)?void 0:s.question,sql:null==(n=null==l?void 0:l.data)?void 0:n.sql}:null}).filter(e=>e),onManagerCreated:(e,t,s)=>{l.current[t]={ctr:s,analysisManager:e,id:t},r.updateAnalysis({analysisId:a.analysisId,isRoot:a.isRoot,updateObj:{analysisManager:e}})},onManagerDestroyed:e=>{r.removeAnalysis({analysisId:a.analysisId,isRoot:a.isRoot,rootAnalysisId:a.rootAnalysisId}),r.setActiveAnalysisId(null),t===e&&r.setActiveRootAnalysisId(null),o(!1)},initialConfig:{analysisTreeManager:r},submitFollowOn:d},a.analysisId))]})},T=({predefinedQuestions:e,handleSubmit:t,activeRootAnalysisId:a,activeAnalysisId:s})=>n.j.jsx("div",{className:"grow flex flex-col place-content-center m-auto max-w-full relative z-[1]",children:n.j.jsxs("div",{className:"text-center text-gray-400 rounded-md dark:text-gray-500",children:[n.j.jsx("p",{className:"block mb-4 text-sm font-bold cursor-default",children:"Quickstart"}),n.j.jsx("ul",{className:"font-light text-gray-500 dark:text-gray-400",children:e.map((e,l)=>n.j.jsx("li",{children:n.j.jsx("button",{className:(0,n.t)("cursor-pointer text-sm p-2 m-1 border border-gray-200 dark:border-gray-700 rounded-md shadow-sm","hover:bg-gray-50 dark:hover:bg-gray-800 hover:border"),onClick:()=>{t((0,n.A)(e),a,!a,s)},children:(0,n.A)(e)})},l))})]})});function R({analysisTreeManager:e,dbName:t,isTemp:a=!1,forceSqlOnly:r=!1,metadata:i=null,predefinedQuestions:o=[],autoScroll:d=!0,sideBarClasses:c="",searchBarClasses:u="",searchBarDraggable:y=!0,defaultSidebarOpen:m=!1,onTreeChange:h=()=>{},beforeTitle:g=null}){let f=(0,l.useContext)(n.a),{token:x,apiEndpoint:p}=(0,l.useContext)(s.Q),j=(0,l.useRef)(null),b=(0,l.useRef)({}),v=(0,l.useRef)(null),C=(0,l.useRef)(!1),[q,R]=(0,l.useState)(!1),[O,M]=(0,l.useState)(!0),[D,L]=(0,l.useState)(""),[B,P]=(0,l.useState)(m),[F,z]=(0,l.useState)(e.getActiveAnalysisId()),[Q,U]=(0,l.useState)(e.getActiveRootAnalysisId()),[$,G]=(0,l.useState)(e.getAll()),W=(0,n.s)({protocol:"http",path:"edit_chart",apiEndpoint:p}),V=(0,l.useSyncExternalStore)(e.subscribeToDataChanges,e.getTree),H=(0,l.useMemo)(()=>e.getNestedTree(),[V]),K=A(H,V);(0,l.useEffect)(()=>{let t=e.setActiveAnalysisId;return e.setActiveAnalysisId=a=>(z(a),t.call(e,a)),()=>{e.setActiveAnalysisId=t}},[e]),(0,l.useEffect)(()=>{let t=e.setActiveRootAnalysisId;return e.setActiveRootAnalysisId=a=>(U(a),t.call(e,a)),()=>{e.setActiveRootAnalysisId=t}},[e]),(0,l.useEffect)(()=>{G(e.getAll())},[V]);let J=I(e,t,r,O,a,x,p,f,W,j,b,R);(0,l.useEffect)(()=>{R(!1),b.current={}},[e]),(0,l.useEffect)(()=>{a||h(t,V)},[h,t,V,a]),S($,b),E(F,d,b,v,C);let Y=(0,l.useCallback)(()=>{let t=e.getAll(),{id:a}=(0,n.E)(Object.keys(t));if(!a||a===e.getActiveAnalysisId())return;let s=t[a].rootAnalysisId;e.setActiveAnalysisId(a),e.setActiveRootAnalysisId(s)},[]);return n.j.jsx(s.h,{children:n.j.jsxs("div",{className:"flex flex-row w-full h-full max-w-full text-gray-600 bg-white dark:bg-gray-900 analysis-tree-viewer",children:[n.j.jsx("div",{className:"absolute left-0 top-0 z-[20] lg:sticky h-full",children:n.j.jsx(n.k,{location:"left",open:B,onChange:e=>{P(e)},beforeTitle:g,title:n.j.jsxs("span",{className:"font-bold",children:["History",n.j.jsx("span",{title:"Clear history",className:"inline pl-2 text-xs font-light text-gray-400 underline cursor-pointer dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-500",onClick:()=>{e.reset(),e.setActiveAnalysisId(null),e.setActiveRootAnalysisId(null)},children:"Clear"})]}),rootClassNames:(0,n.t)("transition-all z-20 h-[calc(100%-1rem)] absolute left-0 min-h-full shadow-2xl lg:shadow-none lg:sticky top-0 bg-gray-50 z-20",c),contentClassNames:"w-72 p-4 rounded-tl-lg relative sm:block min-h-96 h-full",children:n.j.jsxs("div",{className:"flex flex-col w-full h-full overflow-y-auto",children:[n.j.jsx("div",{className:"sticky top-0 mb-4",children:n.j.jsx(w,{isDummy:!0,onClick:()=>{L(""),C.current=!0,e.setActiveRootAnalysisId(null),e.setActiveAnalysisId(null)}})}),Object.entries(K).map(([t,a])=>0===a.length?null:n.j.jsxs("div",{className:"mb-6",children:[n.j.jsx("div",{className:"px-2 mb-2 text-xs font-medium tracking-wide text-blue-400 uppercase",children:t}),a.map(t=>{let a=H[t];return n.j.jsx("div",{children:n.j.jsx(w,{analysis:a,activeAnalysisId:F,onClick:a=>{e.setActiveRootAnalysisId(t),e.setActiveAnalysisId((null==a?void 0:a.analysisId)||t),window.innerWidth<n.G.lg&&P(!1),v.current&&(clearTimeout(v.current),v.current=null,C.current=!1),v.current=setTimeout(()=>{C.current=!0,d&&N((null==a?void 0:a.analysisId)||t,b),C.current=!1},200)},extraClasses:(0,n.t)("ml-4")},null==a?void 0:a.analysisId)},null==a?void 0:a.analysisId)})]},t))]})})}),n.j.jsx("div",{className:(0,n.t)("absolute left-0 top-0 h-full w-full overlay lg:hidden bg-gray-800 dark:bg-gray-900 z-[11] transition-all",B?"opacity-50 block":"opacity-0 pointer-events-none"),onClick:()=>{P(!1)}}),n.j.jsxs("div",{className:(0,n.t)("relative w-full h-full min-w-0 p-2 pt-10 overflow-y-auto overflow-x-clip rounded-tr-lg sm:pt-0 grow lg:p-4",F?"":"flex flex-col"),onScroll:(0,s.N)(e=>{C.current||(e.stopPropagation(),Y())},100),children:[F&&Q&&H[Q]&&n.j.jsx(_,{dbName:t,activeRootAnalysisId:Q,nestedTree:H,metadata:i,analysisDomRefs:b,analysisTreeManager:e,autoScroll:d,setLoading:R,submitFollowOn:L}),!F&&(q?n.j.jsx("div",{className:"flex items-center justify-center h-full",children:n.j.jsx(n.z,{})}):n.j.jsx(T,{predefinedQuestions:o,handleSubmit:J,activeRootAnalysisId:Q,activeAnalysisId:F})),n.j.jsx("div",{className:y?"":"fixed bottom-1 z-40 lg:w-4/6 w-11/12 mx-auto left-0 right-0",children:n.j.jsx(s.P,{ref:j,searchBarClasses:u,searchBarDraggable:y,handleSubmit:J,loading:q,activeRootAnalysisId:Q,activeAnalysisId:F,forceSqlOnly:r,setSqlOnly:M,sqlOnly:O,question:D,onNewConversationTextClick:()=>{C.current=!0,e.setActiveRootAnalysisId(null),e.setActiveAnalysisId(null),window.innerWidth<n.G.lg&&P(!1)}})})]})]})})}function O(e={},t=crypto.randomUUID()){let a=!function(e){if(!e||"object"!=typeof e)return!1;for(let t in e){if("string"!=typeof t)return!1;let a=e[t];if(!a||"object"!=typeof a||!a.root||!a.analysisList||"object"!=typeof a.root||!Array.isArray(a.analysisList)||!M(a.root)||!a.analysisList.length||a.analysisList[0].analysisId!==a.root.analysisId||t!==a.root.analysisId)return!1;for(let e of a.analysisList)if(!M(e)||e.rootAnalysisId!==a.root.analysisId)return!1}return!0}(e)?{}:e,s={},n=Object.values(a).reduce((e,t)=>({...e,[t.root.analysisId]:t.root,...t.analysisList.reduce((e,t)=>({...e,[t.analysisId]:t}),{})}),{}),l=[],r=[],i={},o=null,d=null;function c(e,t){a=e,n=t,l.forEach(e=>e())}function u(){r.forEach(e=>e())}function y(e,t){s[e]=t,i[e]||(i[e]=[]),i[e].forEach(e=>{try{e()}catch(e){console.error("Error in active tab listener",e)}})}async function m({question:e,dbName:t,analysisId:s,rootAnalysisId:l,isRoot:r=!1,directParentId:i=null,sqlOnly:o=!1,isTemp:d=!1,activeTab:u}){let m={analysisId:s,isRoot:r,rootAnalysisId:r?s:l,user_question:e,isTemp:d,dbName:t,sqlOnly:o,timestamp:Date.now(),activeTab:u};m.directParentId=i,m.createAnalysisRequestBody={initialisation_details:{user_question:e,is_root_analysis:r,root_analysis_id:l,direct_parent_id:i},sql_only:o};let h={...a};r?h[m.analysisId]={root:m,analysisList:[m]}:h[a[l].root.analysisId].analysisList.push(m);let g={...n,[m.analysisId]:m};return y(m.analysisId,u||"table"),c(h,g),{newAnalysis:m}}return{subscribeToDataChanges:function(e){return l=[...l,e],function(){l=l.filter(t=>t!==e)}},getTree:function(){return a},getNestedTree:function(){let e={};for(let t in Object.keys(n).forEach(t=>{e[t]={...n[t],children:[],parent:null,flatOrderedChildren:[],allParents:[]}}),Object.keys(e).forEach(t=>{if(e[t].directParentId){let a=e[e[t].directParentId];a&&(e[t].parent=a,e[t].allParents=function(e){let t=[],a=e;for(;a;)t.push(a),a=a.parent;return t}(a),a.children.push(e[t]),a.children.sort((e,t)=>t.timestamp-e.timestamp))}}),e)e[t].isRoot?e[t].flatOrderedChildren=function e(t){return[...t.children,...t.children.flatMap(e)]}(e[t]):delete e[t];return e},getAll:function(){return n},subscribeToActiveAnalysisIdChanges:function(e){return r.push(e),function(){r=r.filter(t=>t!==e)}},getActiveTab:function(e){return s[e]||"table"},setActiveTab:y,subscribeToActiveTabChanges:function(e,t){return e?(i[e]&&Array.isArray(i[e])||(i[e]=[]),i[e].push(t),function(){e&&i[e]&&(i[e]=i[e].filter(e=>e!==t))}):()=>{}},setActiveAnalysisId:function(e){o=e,u()},setActiveRootAnalysisId:function(e){d=e,u()},getActiveAnalysisId:function(){return o},getActiveRootAnalysisId:function(){return d},submit:m,removeAnalysis:function({analysisId:e,isRoot:t,rootAnalysisId:s}){let l={...a};t?delete l[e]:s&&a[s].root&&(l[s].analysisList=l[s].analysisList.filter(t=>t.analysisId!==e));let r={...n};delete r[e],c(l,r)},updateAnalysis:function({analysisId:e,isRoot:t,updateObj:s,emit:l=!0}){let r={...a};if(!n[e]){console.warn("Analysis not found",e);return}t&&(r[e].root={...r[e].root,...s});let i=n[e].rootAnalysisId;r[i].analysisList=r[i].analysisList.map(t=>t.analysisId===e?{...t,...s}:t);let o={...n};o[e]={...o[e],...s},c(r,o)},getMgrId:()=>t,reset:function(){c({},{})}}}function M(e){return!(!e||"object"!=typeof e||!e.analysisId||"string"!=typeof e.analysisId||!e.createAnalysisRequestBody||"object"!=typeof e.createAnalysisRequestBody||"string"!=typeof e.directParentId&&null!==e.directParentId||"boolean"!=typeof e.isRoot||"boolean"!=typeof e.isTemp||"string"!=typeof e.dbName||"string"!=typeof e.rootAnalysisId||"boolean"!=typeof e.sqlOnly||"string"!=typeof e.user_question)}function D({metadata:e=null}){(0,l.useMemo)(()=>e&&Array.isArray(e)?Array.from(new Set(e.map(e=>e.table_name))):[],[e]);let t=Array.isArray(e)?[{dataIndex:"table_name",title:"table_name",key:"table_name"},{dataIndex:"column_name",title:"column_name",key:"column_name"},{dataIndex:"column_description",title:"column_description",key:"column_description"},{dataIndex:"data_type",title:"data_type",key:"data_type"}]:[];return e?n.j.jsx(s.h,{children:Array.isArray(e)&&n.j.jsx(n.j.Fragment,{children:n.j.jsx("div",{className:"flex flex-col justify-center w-full",children:n.j.jsx(n.f,{pagination:{defaultPageSize:10},paginationPosition:"top",rootClassNames:"rounded-md max-w-full",columns:t,rows:e,columnHeaderClassNames:"py-2"})})})}):n.j.jsx("div",{className:"flex items-center justify-center w-full h-full bg-gray-50 text-sm text-gray-400",children:"No metadata available"})}let L=({apiEndpoint:e,token:t,onDbCreated:a=(...e)=>{}})=>{let s=(0,l.useContext)(n.a),[r,i]=(0,l.useState)(!1);return n.j.jsxs("div",{className:"min-w-full min-h-full",children:[n.j.jsx(n.D,{disabled:r,rootClassNames:(0,n.t)(r?"hidden":""),acceptedFileTypes:Object.values(n.F),showIcon:!0,onFileSelect:async l=>{i(!0),l.preventDefault(),l.stopPropagation();try{let r=l.target.files[0];if(!r||!(0,n.i)(r.type))throw Error("Only CSV or Excel files are accepted");let o=await r.arrayBuffer();if("text/csv"===r.type)try{let{dbName:l}=await (0,n.u)(e,t,r.name,(0,n.d)(o)).catch(e=>{throw e});s.success(`DB ${l} created successfully`),a(l)}catch(e){throw i(!1),e}else try{let{dbName:l}=await (0,n.u)(e,t,r.name,(0,n.d)(o)).catch(e=>{throw e});s.success(`DB ${l} created successfully`),a(l)}catch(e){throw i(!1),e}}catch(e){console.error(e),s.error("Failed to parse the file")}},onDrop:async l=>{var r,o;i(!0),l.preventDefault(),l.stopPropagation();try{let d=null==(o=null==(r=null==l?void 0:l.dataTransfer)?void 0:r.items)?void 0:o[0];if(!d||!d.kind||"file"!==d.kind)throw Error("Invalid file");if(!(0,n.i)(d.type))throw Error("Only CSV or Excel files are accepted");let c=d.getAsFile(),u=performance.now(),y=await c.arrayBuffer();if("text/csv"===c.type)try{let{dbName:l}=await (0,n.u)(e,t,c.name,(0,n.d)(y)).catch(e=>{throw e}),r=performance.now();console.log(`CSV upload took ${r-u}ms`),s.success(`DB ${l} created successfully`),a(l)}catch(e){throw i(!1),e}else try{let{dbName:l}=await (0,n.u)(e,t,c.name,(0,n.d)(y));s.success(`DB ${l} created successfully`),a(l)}catch(e){throw i(!1),e}}catch(e){s.error(e.message||"Failed to parse the file"),console.log(e.stack)}}}),r&&n.j.jsxs("div",{className:"text-xs flex w-full h-full items-center justify-center gap-1",children:[n.j.jsx(n.b,{})," Uploading your file"]})]})};function B({apiEndpoint:e,token:t,initialDbList:a=[],initialTrees:r={},hideRawAnalysis:i=!1,hiddenCharts:o=[],hideSqlTab:d=!1,hidePreviewTabs:c=!1,searchBarDraggable:u=!1,onTreeChange:y=(...e)=>{}}){let[m,h]=(0,l.useState)(!1),[g,f]=(0,l.useState)((0,s.U)({token:t,hideRawAnalysis:i,hiddenCharts:o,hideSqlTab:d,hidePreviewTabs:c,apiEndpoint:e}));g.updateConfig=e=>{f(t=>({...t,...e}))};let{current:x}=(0,l.useRef)(crypto.randomUUID().toString()),[p,j]=(0,l.useState)(a),b=(0,l.useRef)(a.reduce((e,t)=>(e[t.name]={dbName:t.name,predefinedQuestions:t.predefinedQuestions,treeManager:O(r[t.name]||{})},e),{})),[v,w]=(0,l.useState)(null),{current:N}=(0,l.useRef)((0,n.g)()),[A,C]=(0,l.useState)(!1);(0,l.useEffect)(()=>{!async function(){let a={};for await(let s of p)if(s.name!==x)try{let l=await (0,n.L)(e,t,s.name);a[s.name]=l}catch(e){console.error(e),a[s.name]=null}let s=p.map(e=>({...e,metadata:a[e.name]}));w(s[0]),j(s),h(!0)}()},[]);let I=(0,l.useMemo)(()=>v&&m?n.j.jsx(n.S,{label:"Select database",popupClassName:"!max-w-full",rootClassNames:"mb-2",value:null==v?void 0:v.name,allowClear:!1,placeholder:"Select Database",allowCreateNewOption:!1,options:[{value:x,label:"Upload new"}].concat(p.map(e=>({value:e.name,label:e.name}))),onChange:e=>{let t=p.find(t=>t.name===e);e===x?C(!0):w(t||p[0])}}):null,[v,p]),q=(0,l.useRef)(null);(0,l.useEffect)(()=>{q.current&&(w(p.find(e=>e.name===q.current)||p[0]),q.current=null)},[p]);let S=(0,l.useMemo)(()=>v&&m?n.j.jsx(s.h,{children:n.j.jsx(R,{defaultSidebarOpen:!0,beforeTitle:I,searchBarDraggable:u,dbName:v.name,metadata:v.metadata,analysisTreeManager:b.current[v.name].treeManager,autoScroll:!0,predefinedQuestions:v.predefinedQuestions||[],onTreeChange:(e,t)=>{try{y(e,t)}catch(e){console.error(e)}}})}):null,[v,I,m]),E=(0,l.useMemo)(()=>v&&m?n.j.jsx(D,{metadata:v.metadata}):null,[p,v,m,I]),_=(0,l.useMemo)(()=>[{name:"Query",content:S},{name:"View data structure",content:E}],[S,E]),T=(0,l.useMemo)(()=>n.j.jsx(L,{apiEndpoint:e,token:t,onDbCreated:async a=>{try{b.current={...b.current,[a]:{dbName:a,treeManager:O()}};let s=await (0,n.L)(e,t,a);j(e=>[...e,{name:a,predefinedQuestions:["What are the tables available?","Show me 5 rows"],metadata:s}]),N.success("Database uploaded successfully, access it by the name: "+a),q.current=a}catch(e){N.error(e)}finally{C(!1)}}}),[p]);return n.j.jsxs(n.a.Provider,{value:N,children:[n.j.jsx(n.h,{rootClassNames:"absolute left-0 right-0"}),n.j.jsx(s.Q.Provider,{value:g,children:n.j.jsxs("div",{className:"relative w-full h-full p-2",children:[m?null!=p&&p.length?n.j.jsx(n.e,{size:"small",tabs:_,vertical:!0,contentClassNames:"p-0 mt-2 sm:mt-0 bg-white",defaultTabClassNames:"p-0 sm:mt-0 h-full",selectedTabHeaderClasses:e=>"Tree"===e?"bg-transparent":""}):n.j.jsx("div",{className:"w-full h-full flex items-center justify-center",children:T}):n.j.jsx("div",{className:"w-full h-full flex items-center justify-center",children:n.j.jsx(n.b,{})}),n.j.jsx(n.l,{title:"Upload new database",open:A,footer:!1,onCancel:()=>C(!1),children:T})]})})]})}}}]);