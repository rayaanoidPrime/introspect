(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[91],{3557:(e,a,t)=>{"use strict";t.d(a,{A:()=>s});var r=t(9678);let s=(e,a)=>{if("http"!==e&&"ws"!==e)throw Error("Protocol not supported");return""!==a?"ws"===e?"".concat((r.env.NEXT_PUBLIC_AGENTS_ENDPOINT||"").replace("http","ws"),"/").concat(a):"".concat(r.env.NEXT_PUBLIC_AGENTS_ENDPOINT||"","/").concat(a):"".concat(r.env.NEXT_PUBLIC_AGENTS_ENDPOINT||"")}},4544:(e,a,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/extract-metadata",function(){return t(4773)}])},4773:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>q});var r=t(8017),s=t(4109),l=t(1085),n=t(5183),o=t(295),d=t(2639),i=t(3019),c=t(3774),m=t(3557),u=t(694),p=t(6907),h=t.n(p);let x=e=>{let{token:a,dbInfo:t,onUpdate:l=()=>{}}=e,[n,p]=(0,s.useState)(t.tables||[]),[x,g]=(0,s.useState)(t.selected_tables||[]),[b,f]=(0,s.useState)((null==t?void 0:t.metadata)||[]),[y,j]=(0,s.useState)({}),[w,v]=(0,s.useState)(!1),k=t.db_name,N=(0,s.useContext)(u.oS);(0,s.useEffect)(()=>{f((null==t?void 0:t.metadata)||[]),p((null==t?void 0:t.tables)||[]),g((null==t?void 0:t.selected_tables)||[])},[t]);let _=(0,s.useCallback)(h()(async e=>{try{let t=await fetch((0,m.A)("http","integration/update_metadata"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({metadata:e,token:a,db_name:k})});if(!t.ok)throw Error("Error updating metadata");let r=await t.json();l(k,r),N.success("Metadata updated successfully")}catch(e){N.error("Error updating metadata:")}},500),[k]),C=(e,a)=>{let t=e.target.value,r=b.map(e=>"".concat(e.table_name,"_").concat(e.column_name)===a?{...e,column_description:t}:e);f(r),_(r)},S=(0,s.useMemo)(()=>[{label:"All tables",value:"all"},{label:"Clear all",value:"clear"},...t.tables.map(e=>({label:e,value:e}))],[t]),A=async()=>{console.log("Received tables: ",x),v(!0);try{N.info("Scanning selected tables.");let e=await fetch((0,m.A)("http","integration/generate_metadata"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tables:x,token:a,db_name:k})});if(!e.ok)throw Error("Could not extract metadata from tables");let t=await e.json();l(k,t)}catch(e){console.log(e),N.error("Error fetching metadata - please look at your docker logs for more information.")}finally{v(!1)}},D=[{title:"Table Name",dataIndex:"table_name",key:"table_name",width:"20%",align:"left",render:e=>(0,r.jsx)("span",{className:"p-2 font-bold",children:e})},{title:"Column Name",dataIndex:"column_name",key:"column_name",width:"20%",align:"left",render:e=>(0,r.jsx)("span",{className:"p-2 font-semibold",children:e})},{title:"Data Type",dataIndex:"data_type",key:"data_type",width:"20%",align:"left",render:e=>(0,r.jsx)("span",{className:"p-2 font-mono",children:e})},{title:"Description (Edit to update)",dataIndex:"column_description",key:"column_description",width:"35%",align:"left",render:(e,a)=>{let t="".concat(a.table_name,"_").concat(a.column_name);return(0,r.jsx)(u.fs,{defaultValue:e,autoResize:!0,defaultRows:1,onChange:e=>C(e,t),textAreaClassNames:"resize-none outline-transparent shadow-none"})}}],E=b.map(e=>({key:"".concat(e.table_name,"_").concat(e.column_name),...e})),F=async()=>{let e=await fetch((0,m.A)("http","integration/get_metadata"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:a,db_name:k,format:"csv"})}),t=await e.json();if(t.error)N.error(t.error);else{let e=window.URL.createObjectURL(new Blob([t.metadata])),a=document.createElement("a");a.href=e,a.setAttribute("download","metadata.csv"),document.body.appendChild(a),a.click(),document.body.removeChild(a)}},T=async()=>{let e=document.createElement("input");e.type="file",e.accept=".csv",e.onchange=async e=>{let t=e.currentTarget.files[0],r=new FileReader;r.onload=async e=>{let t=e.target.result,r=await fetch((0,m.A)("http","integration/upload_metadata"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:a,db_name:k,metadata_csv:t})});if(r.ok)l(k,await r.json()),N.success("Metadata uploaded successfully!");else{N.error("Error uploading metadata");return}},r.readAsText(t)},v(!0),e.click(),v(!1)};return w?(0,r.jsxs)("div",{className:"relative space-y-4",children:[(0,r.jsxs)("div",{className:"absolute inset-0 z-10 flex items-center justify-center bg-white/70 dark:bg-gray-900/70 backdrop-blur-[1px]",children:[(0,r.jsx)(u.c5,{classNames:"text-blue-500 h-6 w-6"}),(0,r.jsx)("span",{className:"ml-2 text-gray-600 dark:text-gray-300",children:"Fetching metadata..."})]}),(0,r.jsx)("div",{className:"pointer-events-none",children:(0,r.jsx)("div",{className:"space-y-2 p-4",children:(0,r.jsx)("div",{className:"text-lg font-medium text-center dark:text-dark-text-primary",children:"View and Update Metadata"})})})]}):(0,r.jsxs)("div",{className:"space-y-10",children:[(0,r.jsxs)("div",{className:"flex flex-row items-center text-blue-500 rounded-lg dark:text-blue-300 gap-2 text-sm",children:[(0,r.jsx)(o.A,{}),"Extracting table and column metadata helps our AI generate more accurate SQL queries."]}),(0,r.jsxs)("div",{className:"flex flex-row items-start gap-2 w-full border-b pb-10",children:[n&&(0,r.jsx)(u.KF,{placeholder:"Select tables for metadata extraction. Leave empty to process all tables.",options:S,value:x,allowCreateNewOption:!0,onChange:e=>{if(e.indexOf("all")>-1){g(n);return}if(e.indexOf("clear")>-1){g([]);return}g(e)},rootClassNames:"max-w-full grow"}),(0,r.jsxs)(u.$n,{onClick:A,disabled:w,variant:"primary",className:"flex flex-col gap-2 min-h-full",children:[(0,r.jsx)(d.A,{}),"Extract AI Metadata"]})]}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)("h3",{className:"text-lg font-medium dark:text-dark-text-primary",children:"Current Metadata"}),(0,r.jsx)(u.XI,{rootClassNames:"!p-0",columns:D,rows:E,pagination:{defaultPageSize:10,showSizeChanger:!0},paginationPosition:"bottom",rowCellRender:e=>{let{cellValue:a,row:t,dataIndex:s,column:l}=e;return"function"==typeof l.render?(0,r.jsx)("td",{className:"px-3 py-2 align-top text-sm text-gray-700 dark:text-gray-200",children:l.render(a,t)},"".concat(t.key,"-").concat(s)):(0,r.jsx)("td",{className:"px-3 py-2  align-top text-sm text-gray-700 dark:text-gray-200",children:a},"".concat(t.key,"-").concat(s))}}),(0,r.jsxs)("div",{className:"flex justify-center my-4 gap-4",children:[(0,r.jsxs)(u.$n,{disabled:w,onClick:F,children:[(0,r.jsx)("span",{children:"Download"})," ",(0,r.jsx)(i.A,{className:"h-4 w-4"})]}),(0,r.jsxs)(u.$n,{disabled:w,onClick:T,children:[(0,r.jsx)("span",{children:"Upload"})," ",(0,r.jsx)(c.A,{className:"h-4 w-4"})]})]})]})]})};var g=t(6428);let b=async(e,a)=>{let t=await fetch((0,m.A)("http","integration/get_db_info"),{method:"POST",body:JSON.stringify({token:e,db_name:a}),headers:{"Content-Type":"application/json"}});if(t.ok)return await t.json();throw Error("Failed to get tables and db creds")},f=async(e,a)=>{let t=await fetch((0,m.A)("http","integration/delete_db_info"),{method:"POST",body:JSON.stringify({token:e,db_name:a}),headers:{"Content-Type":"application/json"}});if(t.ok)return await t.json();throw Error("Failed to delete db info")},y={postgres:["host","port","user","password","database"],mysql:["host","user","password","database"],redshift:["host","port","user","password","database","schema"],snowflake:["account","warehouse","user","password"],databricks:["server_hostname","access_token","http_path","schema"],bigquery:["credentials_file_content"],sqlserver:["server","database","user","password"]},j={host:"host.docker.internal",port:"5432",user:"Database User",database:"Database Name",server_hostname:"Server Hostname",access_token:"Access Token",http_path:"HTTP Path",schema:"Schema"},w={db_name:"",db_type:"postgres",db_creds:{host:"",port:"",user:"",password:"",database:""}},v=e=>{let{token:a="",existingDbInfo:t=null,onDbUpdatedOrCreated:l=()=>{}}=e,[n,o]=(0,s.useState)(!1),d=(0,s.useContext)(u.oS),[i,c]=(0,s.useState)({...w,...t});(0,s.useEffect)(()=>{t&&c({...w,...t})},[t]);let p=async e=>{e.preventDefault();let t={token:a,db_name:i.db_name,db_type:i.db_type,db_creds:i.db_creds};try{o(!0);let e=await fetch((0,m.A)("http","integration/update_db_creds"),{method:"POST",body:JSON.stringify(t)});if(!e.ok)throw Error("Could not update db creds");let a=await e.json();l(a.db_name,a)}catch(e){console.log(e),d.error(e.message)}finally{o(!1)}};return(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)(u.pd,{label:"Database nickname "+(t?"":"(This is for your reference so make it memorable. This cannot be changed later!)"),status:t&&(null==i?void 0:i.db_name)!==(null==t?void 0:t.db_name)?"error":null,type:"text",name:"db_name",value:(null==i?void 0:i.db_name)||"",onChange:e=>{c({...i,db_name:e.target.value})},disabled:t&&!0}),(0,r.jsx)(u.Z,{rootClassNames:"not-prose",allowClear:!1,label:"Database Type",value:(null==i?void 0:i.db_type)||"postgres",options:[{value:"postgres",label:"PostgreSQL"},{value:"mysql",label:"MySQL"},{value:"redshift",label:"Amazon Redshift"},{value:"snowflake",label:"Snowflake"},{value:"databricks",label:"Databricks"},{value:"bigquery",label:"Google BigQuery"},{value:"sqlserver",label:"Microsoft SQL Server"}],onChange:e=>{c({...i,db_type:e})}}),(null==i?void 0:i.db_type)&&y[i.db_type].map(e=>{var a;return(0,r.jsx)("div",{children:(0,r.jsx)(u.pd,{label:e.charAt(0).toUpperCase()+e.slice(1),type:"password"===e?"password":"text",name:e,value:(null===(a=i.db_creds)||void 0===a?void 0:a[e])||"",onChange:a=>{c({...i,db_creds:{...i.db_creds,[e]:a.target.value}})},placeholder:j[e]||"Enter ".concat(e)})},e)}),(0,r.jsx)(u.$n,{onClick:p,className:"w-full justify-center p-2",variant:"primary",disabled:n||!i.db_name,children:n?"Updating...":t?"Update":"Create"})]})})};var k=t(2316),N=t(3005),_=t(7286),C=t(4468);let S=e=>{let{loading:a,canConnect:t,areTablesIndexed:s,hasNonEmptyDescription:l}=e,n=[{key:"1",title:"Database Setup",description:a?(0,r.jsx)(k.A,{className:"text-gray-500 dark:text-dark-text-primary h-5 w-5"}):t?"Database connection verified":"We could not connect to your database. Please check your connection details.",status:a?(0,r.jsx)(k.A,{className:"text-gray-500 dark:text-dark-text-primary h-5 w-5"}):t?(0,r.jsx)(N.A,{className:"text-[#96c880] h-5 w-5"}):(0,r.jsx)(_.A,{className:"text-[#fc8e8e] h-5 w-5"})},{key:"2",title:"Metadata Setup",description:a?(0,r.jsx)(k.A,{className:"text-gray-500 dark:text-dark-text-primary h-5 w-5"}):s?"AI metadata generated for at least one table":"AI metadata not generated. Queries will be incorrect.",status:a?(0,r.jsx)(k.A,{className:"text-gray-500 dark:text-dark-text-primary h-5 w-5"}):s?(0,r.jsx)(N.A,{className:"text-[#96c880] h-5 w-5"}):(0,r.jsx)(C.A,{className:"text-yellow-500 h-5 w-5"}),blur:!t},{key:"3",title:"Column Descriptions",description:a?(0,r.jsx)(k.A,{className:"text-gray-500 dark:text-dark-text-primary h-5 w-5"}):l?"We found at least one column with a description. You can view and update the metadata.":"We did not find any column descriptions. Queries will be incorrect.",status:a?(0,r.jsx)(k.A,{className:"text-gray-500 dark:text-dark-text-primary h-5 w-5"}):l?(0,r.jsx)(N.A,{className:"text-[#96c880] h-5 w-5"}):(0,r.jsx)(C.A,{className:"text-yellow-500 h-5 w-5"}),blur:!t}];return(0,r.jsx)("div",{className:"mt-4 flex flex-row gap-4",children:n.map(e=>(0,r.jsx)("div",{className:"w-1/3 ".concat(e.blur?"filter blur-sm pointer-events-none opacity-60":""),children:(0,r.jsxs)("div",{className:"h-full bg-white dark:bg-dark-bg-secondary border border-gray-200 dark:border-dark-border rounded-lg",children:[(0,r.jsx)("div",{className:"px-6 py-4 border-b border-gray-200 dark:border-dark-border",children:(0,r.jsxs)("div",{className:"flex items-center justify-between dark:text-dark-text-primary",children:[(0,r.jsx)("span",{className:"text-base font-medium",children:e.title}),(0,r.jsx)("span",{children:e.status})]})}),(0,r.jsx)("div",{className:"px-6 py-4",children:(0,r.jsx)("p",{className:"text-gray-600 dark:text-dark-text-secondary text-sm",children:e.description})})]})},e.key))})};var A=t(8468),D=t(942),E=t(2074);function F(e){let{uploadFiles:a=()=>{},fileUploading:t}=e,l=(0,s.useContext)(u.oS),[n,o]=(0,s.useState)([]);return(0,r.jsxs)("div",{className:"h-96 relative",children:[(0,r.jsx)(u.z8,{disabled:t,acceptedFileTypes:[".csv",".xls",".xlsx",".pdf"],showIcon:!0,allowMultiple:!0,selectedFiles:n,onRemoveFile:e=>{!t&&n.length&&(console.time("OracleNewDb:onRemoveFile"),o(n.filter((a,t)=>t!==e)),console.timeEnd("OracleNewDb:onRemoveFile"))},onFileSelect:async(e,a)=>{console.time("OracleNewDb:onFileSelect"),e.preventDefault(),e.stopPropagation();try{o([...n,...a])}catch(e){console.error(e),l.error("Failed to parse the file")}console.timeEnd("OracleNewDb:onFileSelect")},onInvalidFiles:(e,a,t)=>{l.error(t)},onDrop:async(e,a)=>{e.preventDefault(),e.stopPropagation(),console.time("OracleNewDb:onDrop");try{o([...n,...a])}catch(e){l.error(e.message||"Failed to parse the file"),console.log(e.stack)}console.timeEnd("OracleNewDb:onDrop")}}),(0,r.jsx)(u.$n,{className:(0,E.QP)("absolute bottom-10 p-4 left-0 right-0 mx-auto w-fit rounded-full z-[10] shadow-md",t||!n.length?"pointer-events-none":""),disabled:0===n.length||t,variant:"primary",onClick:async()=>{try{a(n)}catch(e){console.error("Error during file upload:",e),l.error(e.message||"Failed to upload files")}finally{}},children:n.length?t?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(u.c5,{}),"Uploading"]}):"Click to upload":"Select some files"})]})}function T(e){let{token:a,fileUploading:t,uploadFiles:l=()=>{},onCredsSubmit:n=()=>{}}=e,o=(0,s.useMemo)(()=>[{name:"connect-db",headerContent:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(A.A,{className:"w-4"}),"Connect Database"]}),content:(0,r.jsxs)("div",{className:"prose dark:prose-invert max-w-none",children:[(0,r.jsx)("h3",{children:"Connect your database"}),(0,r.jsx)("p",{children:"Connect directly to your existing database to unlock AI-powered insights."}),(0,r.jsx)(v,{token:a,onDbUpdatedOrCreated:(e,a)=>{n(e,a)}})]})},{name:"upload-file",headerContent:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(D.A,{className:"w-4"}),"Upload CSV/Excel/PDFs"]}),content:(0,r.jsxs)("div",{className:"prose dark:prose-invert max-w-none",children:[(0,r.jsx)("h3",{children:"Upload your files here"}),(0,r.jsx)("p",{children:"You can upload CSV/Excel for analysing them. You can upload PDFs to provide more context to the model when generating insights."}),(0,r.jsx)(F,{fileUploading:t,uploadFiles:l})]})}],[t]);return(0,r.jsx)(u.tU,{tabs:o})}var P=t(9675),O=t(800);let I=e=>{let{files:a,token:t,dbName:l,onFilesUploaded:n}=e,[o,d]=(0,s.useState)(!1),[c,p]=(0,s.useState)(null),[h,x]=(0,s.useState)(!1),g=s.useContext(u.oS),b=e=>{let a=(0,m.A)("http","download_pdf/".concat(e));window.open(a,"_blank")},f=e=>{p(e.file_id),x(!0)},y=async()=>{if(c)try{let e=await fetch((0,m.A)("http","delete_pdf/".concat(c,"?token=").concat(t,"&db_name=").concat(l)),{method:"DELETE"});if(!e.ok){let a=await e.json();throw Error(a.error||"Failed to delete file")}let a=await e.json();g.success("File deleted successfully"),x(!1),p(null),n&&n(l,a.db_info)}catch(e){console.error("Error deleting file:",e),g.error("Failed to delete file")}},j=async e=>{if(!l){g.error("No project selected");return}if(0===e.length){g.info("No files selected for upload");return}try{d(!0);let a=new FormData;a.append("token",t),a.append("db_name",l),e.forEach(e=>{a.append("files",e)});let r=await fetch((0,m.A)("http","upload_files"),{method:"POST",body:a});if(!r.ok)throw Error("Failed to upload files");let s=await r.json();g.success("Files uploaded successfully"),n&&n(l,s.db_info)}catch(e){console.error("Error uploading files:",e),g.error("Failed to upload files")}finally{d(!1)}},w=e=>(e.toLowerCase().endsWith(".pdf"),(0,r.jsx)(P.A,{className:"w-6 h-6 text-blue-500"}));return(0,r.jsxs)("div",{className:"prose dark:prose-invert max-w-none mb-6",children:[(0,r.jsx)("h3",{children:"Project Files"}),(0,r.jsx)("p",{children:"Upload PDF documents to provide additional context for your queries and reports. These files can be used as reference materials when generating reports or answering complex questions about your data."}),(0,r.jsx)(u.z8,{onFileSelect:(e,a)=>{0!==a.length&&j(a)},onDrop:(e,a)=>{0!==a.length&&j(a)},onInvalidFiles:(e,a,t)=>{g.error(t)},acceptedFileTypes:[".pdf"],allowMultiple:!0,disabled:o,showIcon:!0,selectedFiles:[],label:"Drag & drop PDF files here or click to browse",rootClassNames:"mb-6"}),(0,r.jsx)("h4",{children:"Your files"}),a&&a.length>0?(0,r.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:a.map(e=>(0,r.jsxs)("div",{className:"border rounded-lg p-4 flex flex-col bg-white dark:bg-gray-800 shadow-sm hover:shadow-md transition-shadow",children:[(0,r.jsxs)("div",{className:"flex items-center mb-3",children:[w(e.file_name),(0,r.jsx)("span",{className:"ml-2 font-medium truncate",children:e.file_name})]}),(0,r.jsxs)("div",{className:"mt-auto pt-3 flex justify-end gap-2",children:[(0,r.jsxs)(u.$n,{variant:"secondary",onClick:()=>b(e.file_id),title:"Download file",children:[(0,r.jsx)(i.A,{className:"w-4 h-4 mr-1"}),"Download"]}),(0,r.jsx)(u.$n,{variant:"secondary",onClick:()=>f(e),title:"Delete file",className:"bg-gray-100 hover:bg-red-100 dark:bg-gray-700 dark:hover:bg-red-900/30 group",children:(0,r.jsx)(O.A,{className:"w-4 h-4 text-gray-600 group-hover:text-red-600 dark:text-gray-300 dark:group-hover:text-red-400"})})]})]},e.file_id))}):(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center py-8 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700",children:[(0,r.jsx)(C.A,{className:"w-10 h-10 mb-3 text-gray-400"}),(0,r.jsx)("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"No files associated with this project."}),(0,r.jsx)("p",{className:"text-gray-400 dark:text-gray-500 text-xs mt-1",children:"Upload PDF files above."})]}),(0,r.jsx)(u.aF,{open:h,onCancel:()=>{x(!1),p(null)},title:"Confirm Deletion",contentClassNames:"w-full max-w-md",footer:(0,r.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,r.jsxs)(u.$n,{variant:"secondary",onClick:y,className:"bg-gray-200 hover:bg-red-100 dark:bg-gray-700 dark:hover:bg-red-900/30 group",children:[(0,r.jsx)(O.A,{className:"w-4 h-4 mr-2 group-hover:text-red-600 dark:group-hover:text-red-400"}),"Delete"]}),(0,r.jsx)(u.$n,{variant:"secondary",onClick:()=>{x(!1),p(null)},children:"Cancel"})]}),children:(0,r.jsxs)("div",{className:"p-4",children:[(0,r.jsxs)("div",{className:"flex items-center mb-4",children:[(0,r.jsx)(C.A,{className:"w-8 h-8 mr-2 text-red-500"}),(0,r.jsx)("h3",{className:"text-lg font-semibold",children:"Delete PDF File"})]}),(0,r.jsx)("p",{children:"Are you sure you want to delete this file? This action cannot be undone."}),(0,r.jsx)("p",{className:"mt-2 text-sm text-gray-500",children:"Deleting this file will remove it from the project and all references to it."})]})})]})};var U=t(1871),L=t(2578),R=t(1039),M=t(9678);let q=()=>{var e;let a=(0,s.useId)(),[o,d]=(0,s.useState)({}),[i,c]=(0,s.useState)(null),m=(0,s.useRef)(""),[p,h]=(0,s.useState)(!0),[y,j]=(0,s.useState)(!1),[w,k]=(0,s.useState)(!1),[N,_]=(0,s.useState)(!1),C=(0,s.useContext)(u.oS),A=(0,l.useRouter)(),D=(0,s.useRef)(null);(0,s.useEffect)(()=>(D.current||(D.current=new Worker(t.tu(new URL(t.p+t.u(336),t.b)),{type:void 0}),D.current.onmessage=e=>{let{type:a,dbName:t,dbInfo:r,error:s}=e.data;"UPLOAD_SUCCESS"===a?(C.success("DB ".concat(t," created successfully")),d(e=>({...e,[t]:r})),c(t)):"UPLOAD_ERROR"===a&&C.error(s||"Failed to upload file"),k(!1)}),()=>{D.current&&(D.current.terminate(),D.current=null)}),[C]),(0,s.useEffect)(()=>{let e=localStorage.getItem("defogToken");if(m.current=e,!e){_(!1),h(!1),setTimeout(()=>{let e=window.location.pathname+window.location.search;A.push({pathname:"/log-in",query:{message:"You are not logged in. Please log in to access database management.",returnUrl:e}})},1500);return}_(!0),(async()=>{h(!0);try{let a=await fetch((M.env.NEXT_PUBLIC_AGENTS_ENDPOINT||"")+"/get_db_names",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})});if(!a.ok)throw Error("Failed to get api key names - are you sure your network is working?");let t=await a.json();console.log("Got database names:",t);let r=t.db_names.filter(e=>e);if(0===r.length){h(!1),d({});return}let s={};r.forEach(e=>{s[e]={db_name:e}});let l=r[0];c(l);try{let e=await b(m.current,l);s[l]=e}catch(e){console.error("Error fetching database info for",l,e)}console.log("Final fetched info:",s),d(s),h(!1)}catch(e){C.error(e.message),console.error(e),h(!1),d({})}})()},[A,C]);let E=i&&o[i]&&(void 0!==o[i].tables||void 0!==o[i].metadata),F=i&&i!==a&&o[i]&&!E,P=o[i]&&o[i].tables&&o[i].tables.length>0,O=o[i]&&o[i].metadata&&o[i].metadata.some(e=>e.column_description&&""!==e.column_description.trim()),q=null===(e=o[i])||void 0===e?void 0:e.can_connect,Q=(0,s.useMemo)(()=>{var e,t,s,l,n;return!i||i===a||p||y?null:[{name:"Database Connection",content:(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(v,{token:m.current,existingDbInfo:o[i],onDbUpdatedOrCreated:(e,a)=>{c(e),d(t=>({...t,[e]:a}))}})})},{name:"AI Metadata Management",content:(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(x,{token:m.current,dbInfo:o[i],onUpdate:(e,a)=>{d(t=>({...t,[e]:a}))}})})},{name:"project-files",headerContent:(0,r.jsxs)("div",{className:"flex items-center",children:["Project Files",(null===(t=o[i])||void 0===t?void 0:null===(e=t.associated_files)||void 0===e?void 0:e.length)>0&&(0,r.jsx)("span",{className:"ml-2 px-2 py-0.5 text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-full",children:null===(l=o[i])||void 0===l?void 0:null===(s=l.associated_files)||void 0===s?void 0:s.length})]}),content:(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(I,{files:(null===(n=o[i])||void 0===n?void 0:n.associated_files)||[],token:m.current,dbName:i,onFilesUploaded:(e,a)=>{d(t=>({...t,[e]:a}))}})})}]},[p,i,o]);return N||p?p?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.A,{}),(0,r.jsx)(g.A,{id:"manage-database",userType:"ADMIN",children:(0,r.jsxs)("div",{className:"w-full h-96 text-gray-500 dark:bg-dark-bg-primary flex items-center justify-center",children:[(0,r.jsx)(u.c5,{}),"Loading"]})})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.A,{}),(0,r.jsx)(g.A,{id:"manage-database",userType:"ADMIN",children:(0,r.jsxs)("div",{className:"w-full dark:bg-dark-bg-primary px-2 md:px-0 mb-4",children:[(()=>{let e=Object.keys(o).map(e=>({value:e,label:e}));return e=[{value:a,label:"Start a new project"},...e],(0,r.jsxs)("div",{className:"flex flex-row my-6 w-full gap-2 items-center",children:[y&&(0,r.jsx)("div",{className:"flex items-center mr-2",children:(0,r.jsx)(u.c5,{classNames:"h-5 w-5 text-blue-500"})}),(0,r.jsx)(u.Z,{disabled:w,label:"Select a project",labelClassNames:"font-bold text-sm",allowClear:!1,allowCreateNewOption:!1,options:e,value:i||void 0,onChange:async e=>{if(c(e),e&&e!==a&&(!o[e]||!o[e].tables))try{j(!0);let a=await b(m.current,e);d(t=>({...t,[e]:a}))}catch(a){C.error("Failed to load database info for ".concat(e,": ").concat(a.message)),console.error(a)}finally{j(!1)}},placeholder:"Select your DB name",rootClassNames:"flex-grow min-w-[250px] w-full",optionRenderer:e=>e.value===a?(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(U.A,{className:"w-4"}),"Start a new project"]}):y&&e.value===i?(0,r.jsxs)("div",{className:"whitespace-pre flex items-center gap-2",children:[(0,r.jsx)(u.c5,{classNames:"h-4 w-4 text-blue-500"}),e.label]}):(0,r.jsxs)("div",{className:"whitespace-pre flex items-center gap-2",children:[(0,r.jsx)(L.A,{className:"w-4"}),e.label]})}),i!==a&&i&&(0,r.jsx)(R.A,{className:"w-5 h-5 relative top-3 cursor-pointer hover:text-rose-500",onClick:()=>{try{f(m.current,i),C.success("Database deleted"),d(e=>{let a={...e};return delete a[i],a}),c(a)}catch(e){console.error(e),C.error("Failed to delete database")}}})]})})(),i&&i!==a?y?(0,r.jsxs)("div",{className:"w-full flex flex-col items-center justify-center p-8",children:[(0,r.jsx)(u.c5,{classNames:"h-8 w-8 text-blue-500 mb-4"}),(0,r.jsx)("p",{className:"text-gray-600 dark:text-gray-300",children:"Loading project details..."})]}):Q?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(S,{loading:p||F||y,canConnect:q,areTablesIndexed:P,hasNonEmptyDescription:O}),(0,r.jsx)("div",{className:"dark:bg-dark-bg-primary mt-4",children:(0,r.jsx)(u.tU,{rootClassNames:"w-full dark:bg-dark-bg-primary min-h-[500px]",tabs:Q.map(e=>({...e,className:"!overflow-y-visible dark:bg-dark-bg-primary dark:text-dark-text-primary dark:hover:bg-dark-hover dark:border-dark-border",selectedClassName:"dark:bg-dark-hover dark:text-dark-text-primary dark:border-b-2 dark:border-blue-500"})),disableSingleSelect:!0,contentClassNames:"border dark:border-gray-700 border-t-none"})})]}):null:(0,r.jsxs)("div",{className:"prose dark:prose-invert max-w-none",children:[0===Object.keys(o).length&&(0,r.jsxs)("div",{className:"max-w-lg mx-auto text-center my-10",children:[(0,r.jsx)("h3",{children:"Welcome to Defog!"}),(0,r.jsx)("p",{children:"Let's get you set up with your first database connection. Connect your data source to start generating AI-powered SQL queries and reports."})]}),(0,r.jsx)(T,{fileUploading:w,token:m.current,uploadFiles:e=>{k(!0),D.current.postMessage({type:"UPLOAD_FILE",token:m.current,files:e})},onCredsSubmit:(e,a)=>{d(t=>({...t,[e]:a})),c(e),C.success("Database ".concat(e," created successfully"))}})]})]})})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.A,{}),(0,r.jsx)("div",{className:"h-screen flex flex-col items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center p-6",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold mb-2",children:"Not Logged In"}),(0,r.jsx)("p",{className:"mb-4",children:"You are not logged in. Redirecting to login page..."}),(0,r.jsx)(u.c5,{})]})})]})}},5183:(e,a,t)=>{"use strict";t.d(a,{A:()=>n});var r=t(8017),s=t(1326),l=t.n(s);let n=()=>(0,r.jsxs)(l(),{children:[(0,r.jsx)("title",{children:"Defog.ai - AI Assistant for Data Analysis"}),(0,r.jsx)("meta",{name:"description",content:"Train your AI data assistant on your own device"}),(0,r.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,r.jsx)("link",{rel:"icon",href:"/favicon.ico"})]})},6428:(e,a,t)=>{"use strict";t.d(a,{A:()=>i});var r=t(8017),s=t(4109),l=t(1085),n=t(694),o=t(3930),d=t(2074);let i=e=>{let{id:a,userType:t,children:i,rootClassNames:c="",contentClassNames:m="max-h-full h-full",containerClassNames:u="flex flex-col md:min-h-screen relative container mx-auto"}=e,[p,h]=(0,s.useState)([]),x=(0,l.useRouter)(),g=e=>{x.push(e)},b=()=>{localStorage.removeItem("defogUser"),localStorage.removeItem("defogToken"),localStorage.removeItem("defogUserType"),g("/log-in")},f=(0,o.usePathname)();return(0,s.useEffect)(()=>{let e=[];h(("ADMIN"==t?[{title:"Admin",href:"#!",children:[{key:"manage-database",title:"Manage Database",href:"/extract-metadata"},{key:"manage-users",title:"Manage Users",href:"/manage-users"},{key:"align-model",title:"Align Model",href:"/align-model"}]},{key:"reports",title:"Reports",href:"/reports"},{key:"logout",classNames:"self-end",title:"Logout",href:"#",onClick:b}]:t?[{key:"reports",title:"Reports",href:"/reports"},{key:"logout",classNames:"self-end",title:"Logout",href:"#",onClick:b}]:[]).map(e=>(e.current=e.href==f,e)).map(e=>(e.children&&(e.children=e.children.map(e=>(e.current=e.href==f,e))),e)))},[t]),(0,r.jsxs)("div",{className:(0,d.QP)(u,c),children:[p.length?(0,r.jsx)(n.jq,{rootClassNames:(0,d.QP)("border-b dark:border-dark-border","bg-white dark:bg-dark-bg-primary","text-primary-text dark:text-dark-text-primary"),items:p.map(e=>({...e,classNames:(0,d.QP)(e.classNames,"hover:bg-gray-100 dark:hover:bg-dark-hover",e.current&&"bg-gray-100 dark:bg-dark-hover")}))}):(0,r.jsx)(r.Fragment,{}),(0,r.jsx)("div",{className:m,children:i})]})}}},e=>{var a=a=>e(e.s=a);e.O(0,[628,361,636,593,792],()=>a(4544)),_N_E=e.O()}]);